name: SCC Product Version Verification

on:
  push:
    tags:
      - 'v*'

jobs:
  verify-version:
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    container:
      image: registry.suse.com/bci/bci-base:latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Install required packages
        run: |
          zypper --non-interactive install bash coreutils findutils tar gzip git
          zypper --non-interactive addrepo https://cli.github.com/packages/rpm/gh-cli.repo
          zypper --non-interactive --gpg-auto-import-keys refresh
          zypper --non-interactive install gh

      - name: Debug GitHub plumbing
        shell: bash
        run: |
          echo "GITHUB_OUTPUT=$GITHUB_OUTPUT"
          echo "GITHUB_STEP_SUMMARY=$GITHUB_STEP_SUMMARY"
          echo "GITHUB_PATH=$GITHUB_PATH"
          
          # Validate they exist
          test -n "$GITHUB_OUTPUT" || (echo "GITHUB_OUTPUT not set" && exit 1)
          test -n "$GITHUB_STEP_SUMMARY" || (echo "GITHUB_STEP_SUMMARY not set" && exit 1)
          test -n "$GITHUB_PATH" || (echo "GITHUB_PATH not set" && exit 1)
          
          # Validate directories are writable
          test -w "$(dirname "$GITHUB_OUTPUT")" || (echo "Cannot write to file_commands dir for GITHUB_OUTPUT" && exit 1)
          test -w "$(dirname "$GITHUB_STEP_SUMMARY")" || (echo "Cannot write to file_commands dir for GITHUB_STEP_SUMMARY" && exit 1)
          test -w "$(dirname "$GITHUB_PATH")" || (echo "Cannot write to file_commands dir for GITHUB_PATH" && exit 1)
          
          # Optional: test writing to each file
          echo "debug-output=ok" >> "$GITHUB_OUTPUT"
          echo "## Debug summary test" >> "$GITHUB_STEP_SUMMARY"
          echo "/tmp/debug-path-test" >> "$GITHUB_PATH"

      - name: Setup Verifier
        uses: rancherlabs/scc-product-version-verifier/actions/download@main

      - run: echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Verify `rancher` Product Version
        uses: rancherlabs/scc-product-version-verifier/actions/verify@main
        with:
          version: ${{ github.ref }}
          staging-code: ${{ secrets.RANCHER_SCC_STAGING_ACCOUNT }}
          production-code: ${{ secrets.RANCHER_SCC_PRODUCTION_ACCOUNT }}
          product-name: rancher

      - name: Verify `rancher-prime` Product Version
        uses: rancherlabs/scc-product-version-verifier/actions/verify@main
        with:
          version: ${{ github.ref }}
          staging-code: ${{ secrets.RANCHER_SCC_STAGING_ACCOUNT }}
          production-code: ${{ secrets.RANCHER_SCC_PRODUCTION_ACCOUNT }}
          product-name: rancher-prime
